@page "/Society"
@inherits SocietyComponentBase
@inject IModalService Modal

@attribute [Authorize]

<h2> My Societies List</h2>
<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Address</th>
            <th>Contact</th>
        </tr>
    </thead>
    <tbody>
        @if (Societies != null)
        {
            @foreach (SocietyModel item in Societies)
            {
                <tr class="cursor-pointer" @onclick="@(() => OpenModal(item))">
                    <td>@item.Name</td>
                    <td>@item.Address</td>
                    <td>@item.Contact</td>
                </tr>
            }
        }
    </tbody>
</table>
@if (Societies == null || Societies != null && Societies.Count == 0)
{
    <p>No Society Found</p>
}

<button class="btn btn-primary" @onclick="@(() => OpenModal(new SocietyModel()))">Add New Society</button>

@code {

    protected override async Task OnInitializedAsync()
    {
        if (System.User != null)
        {
            await base.OnInitializedAsync();
            await GetAllCurrentSociety();

        }
    }

    async Task OpenModal(SocietyModel society)
    {
        var modalParameter = new ModalParameters();
        modalParameter.Add(nameof(society), society);
        modalParameter.Add(nameof(Societies) + "Modal", Societies);
        string label = society.Id == null ? "Add new Society" : "Update Society";
        var formModal = Modal.Show<SocietyModal>(label, modalParameter);
        var result = await formModal.Result;

        if (!result.Cancelled)
        {
            if (result.Data != null)
            {
                bool isDelete = result.Data.ToString() == "Deleted";
                if (isDelete)
                {
                    Societies.Remove(society);
                }
                else
                {
                    var res = (SocietyModel)result.Data;
                    if (Societies != null)
                    {
                        if (society.Id == null && society.Name != res.Name)
                        {
                            Societies.Add(res);
                        }
                        else
                        {
                            Societies.RemoveAll(s => s.Id == res.Id);
                            Societies.Add(res);

                        }
                    }
                    StateHasChanged();
                }
            }
        }
    }
}